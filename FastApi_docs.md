# Документация по FastAPI-приложению

## 1. Общая информация

Приложение предназначено для предсказания риска сердечных приступов на основе обученной модели.

Пользователь может:
- Ввести данные одного пациента и получить предсказание.
- Загрузить CSV-файл с данными нескольких пациентов и получить предсказание в CSV или JSON формате.

**Структура приложения:**

```text
FastAPI_app/
│   app.py              # основной скрипт FastAPI
│   best_pipe.pkl       # сохранённый обученный пайплайн
│   model.py            # класс `Model` c методами `predict_row` и `predict_df`
│
├───templates/          # html-шаблоны
│       start_form.html
│
├───tmp                 # Папка с временными файлами
│       predictions.csv
```

---

## 2. Класс `Model` (model.py)

### 2.1 Инициализация
- Загружает пайплайн модели из `best_pipe.pkl`.
- Определяет признаки, которые использовались при обучении (`feature_cols`), карту признаков (`feature_map`), названия признаков в стиле `snake_case` (`snake_case`) и порог классификации (`threshold`).

## 2.2 Методы
- `predict_row(df: pd.DataFrame) -> int`
    - Принимает DataFrame с одной строкой.
    - Возвращает предсказание 0 или 1.
- `predict_df(df: pd.DataFrame) -> pd.DataFrame`
    - Принимает DataFrame с несколькими строками.
    - Возраващает DataFrame с колонками `id` и `prediction`.

---

## 3. Эндпоинты FastAPI (app.py)

1. Эндпоинт `/`. Метод `GET`. Главная страница с формой для ввода данных одного пациента и загрузки CSV.
2. Эндпоинт `/health`. Метод `GET`. Проверка работы сервиса, возвращает `{'status': 'OK'}`.
3. Эндпоинт `/predict_row`. Метод `POST`. Получает строку с признаками через форму, асинхронно возвращает предсказание для одного пациента на той же странице.
4. Эндпоинт `/predict_csv`. Метод `POST`. Получает CSV-файл, выполняет предсказания для всех строк, асинхронно возвращает ссылку на скачивание CSV с результатами, а также ссылку на вывод результатов в формате JSON, на той же странице.
5. Эндпоинт `/predictions_json`. Метод `GET`. Выводит полученные предсказания из эндпоинта `/predict_csv` в формате JSON.

---

## 4. Валидация и обработка ошибок
- Проверка, что для `/predict_row` строка имеет правильное количество признаков (27).
- Проверка, что файл для `/predict_csv` имеет расширение `.csv`.
- Проверка соответствия столбцов CSV ожидаемым признакам (`snake_case`).
- Ошибки выводятся в формате JSON или на странице в интерфейсе.

---

## 5. Используемые JavaScript функции
- Обработка переданной строки для `/predict_row`:
    - Проверка количества признаков.
    - Отображение ошибок внутри контейнера формы.
    - Асинхронный вывод предсказания на экране без перезагрузки страницы.
- Обработка загрузки CSV для `/predict_csv`:
    - Проверка формата файла.
    - Проверка совпадения признаков.
    - Асинхронный вывод ссылок для скачивания CSV с предсказаниями и просмотра JSON.

---

## 6. Кастомные трансформеры
- Используются в пайплайне модели (`best_pipe.pkl`) для предобработки данных:
    - `ColumnNameCleaner` — приводит названия в столбцах к стилю `snake-case`
    - `SimpleImputerStep` — заполняет пропуски в количественных столбцах медианным значением, а в бинарных столбцах модой.
    - `GenderCleaner` — оставляет только два класса в столбце `Gender` (1 - мужчина, 0 - женщина)
    - `TypeConverter` — приводит тип столбцов, в которых есть только бинарные значения, а также малые целочисленные значения (1-10), к типу `int8` ради экономии памяти.

---

## 7. Примечания по запуску
1. Установить/активировать виртуальное окружение.
2. Установить зависимости из `requirements.txt`.
3. Запустить приложение:
```bash
cd FastAPI_app
uvicorn app:app --reload --port 8010
```
4. Открыть браузер по адресу http://127.0.0.1:8010/или http://localhost:8010/